# Pi Drone Navigation - Default Configuration
# Copy this file to config.yaml and modify as needed

# Serial port settings
serial:
  # MSP serial port (FC connection)
  msp_port: "/dev/ttyACM0"
  msp_baudrate: 115200

  # GPS serial port
  gps_port: "/dev/ttyAMA0"
  gps_baudrate: 115200

  # Auto-detect serial ports
  auto_detect: true

# GPS settings
gps:
  # Update rate in Hz (1-10)
  update_rate: 10

  # Protocol (ubx or nmea)
  protocol: "ubx"

  # Minimum satellites for valid fix
  min_satellites: 6

  # Enable SBAS (WAAS/EGNOS)
  enable_sbas: true

  # Position filtering
  filter_enabled: true
  filter_samples: 5

  # Fallback to MSP GPS from Betaflight if UBX GPS unavailable at startup
  # Note: MSP GPS has no vertical velocity (vel_down = 0)
  msp_fallback: true

# Navigation settings
# Gains aligned with iNav defaults (see navigation.c:4898-4945)
navigation:
  # Position controller gains (iNav: nav_mc_pos_xy_p = 65 / 100)
  position_kp: 0.65

  # Velocity controller gains (iNav: nav_mc_vel_xy_*)
  # P = 40/20 = 2.0, I = 15/100 = 0.15, D = 100/100 = 1.0
  velocity_kp: 2.0
  velocity_ki: 0.15
  velocity_kd: 1.0

  # Maximum speeds (m/s)
  max_horizontal_speed: 10.0
  max_vertical_speed: 3.0
  max_descent_speed: 2.0

  # Maximum tilt angle (degrees)
  max_tilt: 30.0

  # Jerk limit for smooth control (m/s³)
  # iNav: MC_POS_CONTROL_JERK_LIMIT_CMSSS = 1700 cm/s³ = 17 m/s³
  jerk_limit: 17.0

  # Waypoint acceptance radius (m)
  default_waypoint_radius: 2.0

  # Control loop frequency (Hz)
  loop_frequency: 50

# Altitude settings
# Gains aligned with iNav defaults (see navigation.c:4929-4945)
altitude:
  # Source priority (auto, baro_fc, baro_pi, gps)
  source: "auto"

  # Position Z controller (iNav: nav_mc_pos_z_p = 50 / 100)
  kp: 0.5

  # Velocity Z controller (climb rate -> throttle)
  # iNav: P = 100/66.7 = 1.5, I = 50/20 = 2.5, D = 10/100 = 0.1
  vel_kp: 1.5
  vel_ki: 2.5
  vel_kd: 0.1

  # Hover throttle (0.0-1.0)
  hover_throttle: 0.5

  # Throttle limits
  min_throttle: 0.1
  max_throttle: 0.9

  # Ground effect compensation
  ground_effect_height: 1.0

# Failsafe settings
failsafe:
  # GPS loss action (hold, land, rth)
  gps_loss_action: "hold"

  # GPS loss timeout (seconds)
  gps_loss_timeout: 3.0

  # Low battery action (land, rth)
  low_battery_action: "rth"

  # Low battery threshold (volts)
  low_battery_voltage: 10.5

  # Critical battery threshold (volts)
  critical_battery_voltage: 9.5

  # RC loss timeout (seconds) - 0 to disable
  rc_loss_timeout: 2.0

  # Maximum altitude (m)
  max_altitude: 120.0

  # Geofence radius (m) - 0 to disable
  geofence_radius: 500.0

  # Return to home altitude (m)
  rth_altitude: 30.0

# Interface settings
interface:
  # REST API
  rest_api_enabled: true
  rest_api_port: 8080
  rest_api_host: "0.0.0.0"

  # WebSocket (future)
  websocket_enabled: false
  websocket_port: 8081

  # MAVLink
  mavlink_enabled: true
  mavlink_port: 14550
  mavlink_system_id: 1

  # CLI
  cli_enabled: true

# Simulation settings
simulation:
  # Enable SITL mode
  enabled: false

  # SITL host (Betaflight SITL)
  sitl_host: "127.0.0.1"
  sitl_port: 5761

  # Simulated GPS
  simulated_gps: true
  start_latitude: 48.8566
  start_longitude: 2.3522
  start_altitude: 0.0

# Logging settings
logging:
  # Log level (DEBUG, INFO, WARNING, ERROR)
  level: "INFO"

  # Log to file
  log_to_file: true
  log_directory: "logs"

  # Flight data logging
  flight_log_enabled: true
  flight_log_rate: 10  # Hz

# Takeoff settings (iNav-style velocity PID)
# Uses same velocity Z gains as altitude controller (iNav nav_mc_vel_z_*)
takeoff:
  # Target
  default_altitude_m: 3.0
  target_climb_rate_ms: 0.3     # Target vertical speed during climb (m/s) - TEST: très lent

  # Spinup phase
  spinup_time_ms: 500           # Motor spinup before PID engages
  spinup_throttle: 0.15         # Throttle at end of spinup

  # Velocity PID (iNav nav_mc_vel_z_*: P=100/66.7, I=50/20, D=10/100)
  # dt is used correctly in PID, so no frequency adjustment needed
  vel_kp: 1.5                   # iNav: 100/66.7 = 1.5
  vel_ki: 2.5                   # iNav: 50/20 = 2.5
  vel_kd: 0.1                   # iNav: 10/100 = 0.1
  vel_i_max: 0.3                # Anti-windup limit
  velocity_filter_hz: 5.0       # iNav: NAV_VEL_Z_DERIVATIVE_CUT_HZ = 5Hz

  # Liftoff detection (iNav-style: throttle + gyro)
  liftoff_gyro_threshold_dps: 7.0   # Gyro activity threshold (deg/s)
  liftoff_throttle_margin: 0.05     # Must be above hover_throttle + margin
  liftoff_confirm_time_s: 0.2       # Confirmation time (200ms)

  # Safety limits
  max_throttle: 0.75            # Never exceed during takeoff
  min_throttle: 0.1             # Never go below
  max_tilt_deg: 35.0            # Abort if tilted more (was 25, too strict with string)
  timeout_s: 10.0               # Abort if no liftoff
  altitude_tolerance_m: 0.5     # Close enough to target

  # Pre-flight checks
  preflight_enabled: true
  min_gps_satellites: 5
  max_hdop: 3.0
  attitude_check_max_tilt_deg: 10.0  # Must be level before takeoff

# Hover throttle learning (ArduPilot MOT_THST_HOVER style)
hover_learn:
  enabled: true
  time_constant_sec: 2.0        # EMA filter time constant

  # Throttle bounds
  min_hover_throttle: 0.2
  max_hover_throttle: 0.8

  # Learning conditions (must be met to update estimate)
  min_altitude_m: 1.0           # Must be above ground
  max_climb_rate_ms: 0.5        # Must be hovering (low climb rate)
  max_horizontal_speed_ms: 1.0  # Must not be maneuvering

  # Persistence
  save_on_disarm: true
  save_file: "hover_throttle.json"

# Landing settings (iNav-style 3-phase landing)
landing:
  # Descent speeds per phase (m/s) - TEST: très lent
  speed_high: 0.5               # Phase haute (> 5m AGL) - iNav: 1.5
  speed_mid: 0.25               # Phase moyenne (1-5m AGL) - iNav: 0.7
  speed_final: 0.15             # Phase finale (< 1m AGL) - iNav: 0.3

  # Altitude thresholds (meters AGL)
  threshold_high: 5.0           # Switch to mid phase below this
  threshold_mid: 1.0            # Switch to final phase below this

  # Touchdown detection - Accelerometer (primary)
  acc_threshold_g: 1.5          # Acceleration spike threshold (in G above baseline)
  acc_filter_hz: 5.0            # Low-pass filter for accelerometer
  touchdown_alt_max: 0.5        # Max altitude for touchdown detection
  touchdown_confirm_time: 0.5   # Seconds to confirm touchdown

  # Touchdown detection - Fallback (altitude + vario)
  fallback_alt_threshold: 0.3   # meters
  fallback_vario_threshold: 0.2 # m/s
  fallback_confirm_time: 2.0    # seconds

  # Auto-disarm after landing
  auto_disarm: true
  disarm_delay: 2.0             # seconds after touchdown confirmed
